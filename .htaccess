# Deny access to sensitive files
<FilesMatch "^(deploy\.sh|composer\.(json|lock|phar)|\.gitignore|\.env)">
    Order allow,deny
    Deny from all
</FilesMatch>

# Enable rewrite engine
RewriteEngine On

# Handle CORS at server level - more comprehensive approach
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
Header always set Access-Control-Allow-Credentials "false"
Header always set Access-Control-Max-Age "3600"

# Enhanced CORS origin handling for both localhost and production
SetEnvIf Origin "^https?://(localhost(:[0-9]+)?|127\.0\.0\.1(:[0-9]+)?|bugs\.moajmalnk\.in|bugbackend\.moajmalnk\.in|bugracers\.vercel\.app)$" CORS_ALLOW_ORIGIN=$0

# Set CORS origin header
Header always set Access-Control-Allow-Origin "%{CORS_ALLOW_ORIGIN}e" env=CORS_ALLOW_ORIGIN

# Fallback for development - allow localhost with any port
Header always set Access-Control-Allow-Origin "*"

# Handle OPTIONS preflight requests more thoroughly
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ - [R=200,L]

# Handle Authorization header
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]

# Set default charset and content type for API endpoints
<FilesMatch "\.php$">
    AddDefaultCharset UTF-8
    # Remove the default Content-Type header to let PHP set it
</FilesMatch>

# Simple routing - if file doesn't exist, try adding .php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} ^/backend/api/
RewriteRule ^backend/api/(.*)$ backend/api/$1.php [L]

# Alternative routing for direct API access
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ api/$1.php [L]

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"

# Error handling
ErrorDocument 404 /backend/api/404.php

# Enable logging
LogLevel warn
php_value log_errors on
php_value error_log "/tmp/php_errors.log"